<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Ghost's Gambling</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Inter', sans-serif; background: #1a1a1a; color: #fff; overflow-x: hidden; }
    header { display: flex; justify-content: space-between; align-items: center; padding: 1rem 2rem; background: #1a1a1a; border-bottom: 2px solid #800000; }
    header nav a { margin: 0 1rem; font-size: 1.6rem; color: white; text-decoration: none; cursor: pointer; }
    header nav a:hover { color: #ff3333; }
    header .bal { font-size: 1.4rem; }
    .container { display: flex; padding: 20px; gap: 20px; height: calc(100vh - 80px); }
    .main-content { flex: 3; background: #1a1a1a; padding: 20px; border-radius: 12px; border: 1px solid #800000; overflow-y: auto; }
    .welcome-title { font-size: 2.8rem; color: #ff0000; margin-bottom: 1rem; }
    .welcome-sub { font-size: 1.5rem; margin-bottom: 1rem; color: #ff9999; }
    .right-panel { flex: 1; display: flex; flex-direction: column; gap: 15px; }
    .members-panel { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #800000; overflow-y: auto; max-height: 260px; font-size: 1.2rem; }
    .members-panel h2 { font-size: 1.4rem; color: #ff0000; margin-bottom: 0.5rem; }
    .chat-container { background: #222; padding: 15px; border-radius: 8px; border: 1px solid #800000; flex: 1; display: flex; flex-direction: column; }
    .chat-messages { flex: 1; overflow-y: auto; margin-bottom: 10px; }
    .chat-messages p { margin: 5px 0; font-size: 1rem; }
    .chat-input { display: flex; gap: 10px; }
    .chat-input input { flex: 1; padding: 8px; background: #111; border: none; border-radius: 5px; color: #fff; font-size: 1rem; }
    .chat-input button { padding: 8px 12px; background: #800000; border: none; border-radius: 5px; color: #fff; font-size: 1rem; cursor: pointer; }
    .chat-input button:hover { background: #660000; }
    .left-panel { background: #1a1a1a; padding: 20px; border-radius: 12px; border: 1px solid #800000; width: 250px; }
    .left-panel label { color: #ff9999; font-size: 0.9rem; }
    .left-panel input, .left-panel select, .left-panel button { width: 100%; padding: 10px; margin: 8px 0; border: none; border-radius: 8px; background: #2d2d2d; color: white; font-size: 1rem; }
    .left-panel button { background: #800000; font-weight: bold; cursor: pointer; }
    .left-panel button:hover { background: #660000; }
    .game-board { background: #1a1a1a; padding: 20px; border-radius: 12px; border: 1px solid #800000; flex-grow: 1; display: flex; flex-direction: column; align-items: center; }
    .game-board h2 { color: #ff0000; font-size: 1.2rem; margin-bottom: 15px; }
    .grid { display: grid; grid-template-columns: repeat(5, 50px); gap: 8px; }
    .cell { width: 50px; height: 50px; border-radius: 8px; background: #800000; color: white; font-size: 1.5rem; display: flex; align-items: center; justify-content: center; cursor: pointer; }
    .cell.safe { background: #ff0000; }
    .cell.mine { background: #1a1a1a; color: #ff0000; }
    .overlay { position: fixed; top: 30%; left: 50%; transform: translateX(-50%); background: #800000; color: #fff; padding: 20px 40px; border-radius: 12px; font-size: 1.4rem; font-weight: bold; display: none; z-index: 9999; }
    /* auth */
    .auth-form { background: #2d2d2d; padding: 40px; border-radius: 12px; border: 1px solid #800000; max-width: 400px; margin: 80px auto; display: flex; flex-direction: column; gap: 15px; }
    .auth-form h2 { color: #ff0000; font-size: 2rem; text-align: center; }
    .auth-form input { padding: 12px; background: #111; border: none; border-radius: 8px; color: white; font-size: 1rem; }
    .auth-form button { padding: 12px; background: #800000; color: white; font-weight: bold; border: none; border-radius: 8px; font-size: 1rem; cursor: pointer; }
    .auth-form p { text-align: center; color: #ff9999; cursor: pointer; }
    .auth-form p:hover { text-decoration: underline; }
  </style>
</head>
<body oncontextmenu="return false;" onkeydown="if(event.keyCode==123|| (event.ctrlKey&&event.shiftKey&&event.keyCode==73)) {event.preventDefault(); return false;}">
  <div id="app">
    <div v-if="page==='login'" class="auth-form">
      <h2>Login</h2>
      <input v-model="loginUsername" placeholder="Username" @keyup.enter="login" />
      <input v-model="loginPassword" type="password" placeholder="Password" @keyup.enter="login" />
      <button @click="login">Login</button>
      <p @click="page='register'">No account? Register here</p>
    </div>
    <div v-if="page==='register'" class="auth-form">
      <h2>Register</h2>
      <input v-model="registerUsername" placeholder="Username" @keyup.enter="register" />
      <input v-model="registerPassword" type="password" placeholder="Password" @keyup.enter="register" />
      <button @click="register">Register</button>
      <p @click="page='login'">Already have an account? Login here</p>
    </div>
    <div v-if="page!=='login'&&page!=='register'" class="container">
      <header>
        <nav>
          <a @click="page='home'">üè† Home</a>
          <a @click="page='blackjack'">üÉè Blackjack</a>
          <a @click="page='mines'">üí£ Mines</a>
        </nav>
        <div class="bal">Balance: {{ balance }}</div>
        <a @click="logout" style="font-size:1.4rem; cursor:pointer;">üö™ Logout</a>
      </header>
      <main class="main-content">
        <div v-show="page==='home'">
          <h2 class="welcome-title">Welcome, {{ username }}! (Dev: Ghost üëª)</h2>
          <p class="welcome-sub">Enjoy your luck ‚Äî and stay sharp.</p>
        </div>
        <!-- Blackjack -->
        <div v-show="page==='blackjack'" id="bj-game">
          <h2>üÉè Blackjack</h2>
          <div class="hand">
            <label>Bet:</label>
            <input type="number" v-model.number="bjBet" min="1"/>
          </div>
          <div class="hand">
            <h3>Your Hand</h3><div ref="playerCards"></div><p>{{ playerTotalText }}</p>
          </div>
          <div class="hand">
            <h3>Dealer's Hand</h3><div ref="dealerCards"></div><p>{{ dealerTotalText }}</p>
          </div>
          <div>
            <button @click="bj_hit">Hit</button>
            <button @click="bj_stand">Stand</button>
            <button @click="bj_newGame">New Game</button>
          </div>
          <p>{{ bjResult }}</p>
        </div>
        <!-- Mines -->
        <div v-show="page==='mines'" class="mines-container">
          <div class="left-panel">
            <h2>Mines Game</h2>
            <label>Bet</label><input type="number" v-model.number="betAmount" min="1"/>
            <label># Mines</label>
            <select v-model.number="mineCount"><option v-for="n in [1,2,3,5,10]" :key="n">{{n}}</option></select>
            <div class="multiplier">{{ multiplier.toFixed(2) }}x</div>
            <button @click="mines_startGame">Start Game</button>
            <button @click="mines_cashout">Cash Out</button>
          </div>
          <div class="game-board"><h2>Pick a Tile</h2><div class="grid" ref="minesGrid"></div></div>
        </div>
      </main>
      <aside class="right-panel">
        <div class="members-panel">
          <h2>Online Players</h2>
          <ul><li v-for="u in onlineUsers" :key="u">{{u}}</li></ul>
        </div>
        <div class="chat-container">
          <h3>üí¨ Chat</h3>
          <div class="chat-messages" ref="chatMessages"><p v-for="m in messages" :key="m.timestamp"><strong>{{m.username}}:</strong> {{m.message}} <span style="color:#ff9999;font-size:0.9rem;">({{new Date(m.timestamp).toLocaleTimeString()}})</span></p></div>
          <div class="chat-input">
            <input v-model="newMessage" @keyup.enter="sendMessage" placeholder="Type a message..." />
            <button @click="sendMessage">Send</button>
          </div>
        </div>
      </aside>
    </div>
  </div>
  <div class="overlay" ref="overlay"><span>üéâ You cashed out! +</span><span ref="cashoutAmount"></span><span> Coins</span></div>

  <script src="https://cdn.jsdelivr.net/npm/vue@3"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
  const app = Vue.createApp({
    data(){ return {
      page:'login', token:null, username:'', balance:0,
      loginUsername:'', loginPassword:'', registerUsername:'', registerPassword:'',
      messages:[], newMessage:'', onlineUsers:[],
      bjBet:100, bj_deck:[], bj_player:[], bj_dealer:[], bj_gameOver:true, bjResult:'', betAmount:100, mineCount:3, multiplier:1, mines_active:false, mines_safe:[], mines_clicked: new Set()
    }},
    computed: {
      playerTotalText(){ return 'Total: ' + this.calcTotal(this.bj_player) },
      dealerTotalText(){ return 'Total: ' + (this.bj_gameOver ? this.calcTotal(this.bj_dealer) : '?') },
    },
    methods: {
      async login(){
        const res = await fetch('/api/login', {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:this.loginUsername,password:this.loginPassword})});
        const d=await res.json();
        if(res.ok){ this.token=d.token; this.username=d.username; await this.fetchBalance(); this.initSocket(); this.page='home'; }
        else alert(d.error);
      },
      async register(){
        const res = await fetch('/api/register',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({username:this.registerUsername,password:this.registerPassword})});
        const d=await res.json();
        if(res.ok){ alert('Registered! Please log in.'); this.page='login'; } else alert(d.error);
      },
      logout(){this.token=null; this.username=''; this.page='login'; if(this.socket) this.socket.disconnect();},
      async fetchBalance(){ if(!this.token) return; const res = await fetch('/api/balance',{headers:{Authorization:`Bearer ${this.token}`}}); const d=await res.json(); if(res.ok) this.balance=d.balance; },
      updateBalance(change){ return fetch('/api/balance/change',{method:'POST',headers:{'Content-Type':'application/json',Authorization:`Bearer ${this.token}`},body:JSON.stringify({change})}).then(r=>r.json()).then(d=>{if(d.balance!=null) this.balance=d.balance; else throw d;}); },
      initSocket(){
        this.socket=io({auth:{token:this.token}});
        this.socket.on('connect',()=>{ this.socket.emit('join',{username:this.username}); });
        this.socket.on('users',u=>this.onlineUsers=u);
        this.socket.on('messages',m=>this.messages=m);
        this.socket.on('message',m=>this.messages.push(m));
      },
      sendMessage(){
        if(this.newMessage.trim()) { this.socket.emit('message',this.newMessage); this.newMessage=''; }
      },
      calcTotal(hand){ let t=0, a=0; hand.forEach(c=>{t+=['J','Q','K'].includes(c.value)?10: (c.value==='A'?11:parseInt(c.value)); if(c.value==='A') a++;}); while(t>21&&a>0){t-=10;a--;} return t; },
      bj_create(){ const suits=['‚ô†','‚ô•','‚ô£','‚ô¶'], values=['A','2','3','4','5','6','7','8','9','10','J','Q','K']; let deck=[]; for(const s of suits) for(const v of values) deck.push({suit:s,value:v}); return deck.sort(()=>Math.random()-0.5); },
      bj_newGame(){
        if(this.bjBet>this.balance){return alert('Insufficient balance');}
        this.updateBalance(-this.bjBet).then(()=>{
          this.bj_deck=this.bj_create(); this.bj_player=[this.bj_deck.pop(),this.bj_deck.pop()]; this.bj_dealer=[this.bj_deck.pop()]; this.bj_gameOver=false; this.bjResult='';
          this.drawHands();
          if(this.calcTotal(this.bj_player)===21) this.bj_end();
        }).catch(()=>alert('Balance update failed'));
      },
      drawHands(){
        const pc=this.$refs.playerCards, dc=this.$refs.dealerCards;
        pc.innerHTML=''; dc.innerHTML='';
        this.bj_player.forEach(c=>{ const e=document.createElement('div'); e.className='card'; e.textContent=c.value+c.suit; pc.appendChild(e); });
        this.bj_dealer.forEach((c,i)=>{ const e=document.createElement('div'); e.className='card'; e.textContent=(i===0 && !this.bj_gameOver)?'?' : c.value+c.suit; dc.appendChild(e); });
      },
      bj_hit(){ if(this.bj_gameOver)return; this.bj_player.push(this.bj_deck.pop()); this.drawHands(); if(this.calcTotal(this.bj_player)>21) this.bj_end(); },
      bj_stand(){ if(this.bj_gameOver)return; while(this.calcTotal(this.bj_dealer)<17) this.bj_dealer.push(this.bj_deck.pop()); this.bj_end(); },
      bj_end(){
        this.bj_gameOver=true; const p=this.calcTotal(this.bj_player), d=this.calcTotal(this.bj_dealer);
        let change=0;
        if(p>21) this.bjResult='You Busted! Dealer wins';
        else if(d>21||p>d){ this.bjResult='You Win!'; change=this.bjBet; }
        else if(p<d){ this.bjResult='Dealer wins'; change=-this.bjBet; }
        else this.bjResult='Push (Tie)!';
        if(change!==0) this.updateBalance(change).catch(()=>alert('Balance update failed'));
        this.drawHands();
      },
      mines_startGame(){
        if(this.betAmount>this.balance){return alert('Insufficient balance');}
        this.updateBalance(-this.betAmount).then(()=>{
          this.multiplier=1; this.mines_clicked.clear(); this.mines_active=true;
          const total=25; const mines=new Set();
          while(mines.size<this.mineCount) mines.add(Math.floor(Math.random()*total));
          this.mines_safe=Array.from({length:total}, (_,i)=>mines.has(i)?'mine':'safe');
          this.renderGrid();
        }).catch(()=>alert('Balance update failed'));
      },
      renderGrid(){
        const grid=this.$refs.minesGrid; grid.innerHTML='';
        this.mines_safe.forEach((status,i)=>{
          const e=document.createElement('div');
          e.className='cell'; e.onclick=()=>this.mines_click(i,e);
          grid.appendChild(e);
        });
      },
      mines_click(i,el){
        if(!this.mines_active||this.mines_clicked.has(i))return;
        this.mines_clicked.add(i);
        if(this.mines_safe[i]==='mine'){
          el.classList.add('mine'); el.textContent='üí£';
          this.mines_active=false; alert('üí• You hit a mine! Game over.');
        } else {
          el.classList.add('safe'); el.textContent='üíé';
          this.multiplier *= 1.15; el.textContent='üíé';
        }
      },
      mines_cashout(){
        if(!this.mines_active||this.mines_clicked.size===0)return;
        const payout=Math.floor(this.betAmount*this.multiplier);
        this.updateBalance(payout).then(()=>{
          this.$refs.cashoutAmount.textContent=`${payout}`;
          this.$refs.overlay.style.display='block';
          setTimeout(()=>this.$refs.overlay.style.display='none',3000);
          this.mines_active=false;
        }).catch(()=>alert('Balance update failed'));
      }
    },
    mounted(){
      if(localStorage.getItem('token')){
        this.token=localStorage.getItem('token');
        this.username=localStorage.getItem('username');
        this.page='home';
        this.fetchBalance();
        this.initSocket();
      }
    }
  }).mount('#app');
  </script>
</body>
</html>
