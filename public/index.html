<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ghosts Gambling - Casino</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">

  <!-- Custom Styles -->
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      background-color: #1a1a1a;
      color: white;
    }

    header {
      padding: 15px 30px;
      display: flex;
      justify-content: space-between;
      background-color: #1a1a1a;
      border-bottom: 1px solid #800000;
    }

    header a {
      color: white;
      text-decoration: none;
      margin: 0 15px;
      font-weight: bold;
    }

    .container {
      display: flex;
      padding: 30px;
      gap: 30px;
      height: calc(100vh - 70px);
    }

    .main-content {
      width: 70%;
      display: flex;
      gap: 30px;
    }

    .members-panel {
      width: 300px;
      background-color: #1a1a1a;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #800000;
    }

    .members-panel h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #ff0000;
    }

    .members-panel ul {
      list-style: none;
      padding: 0;
    }

    .members-panel li {
      padding: 5px 0;
      font-size: 14px;
      color: #ffffff;
    }

    .game-content {
      flex-grow: 1;
      background-color: #1a1a1a;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #800000;
    }

    .left-panel {
      width: 300px;
      background-color: #1a1a1a;
      padding: 20px;
      border-radius: 12px;
      border: 1px solid #800000;
    }

    .left-panel h2 {
      font-size: 18px;
      margin-bottom: 15px;
      color: #ff0000;
    }

    .left-panel label {
      font-size: 13px;
      color: #ff9999;
    }

    .left-panel input,
    .left-panel select {
      width: 100%;
      padding: 10px;
      margin: 8px 0 15px;
      border-radius: 8px;
      border: none;
      background-color: #2d2d2d;
      color: white;
    }

    .left-panel button {
      width: 100%;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background-color: #800000;
      color: white;
      font-weight: bold;
      cursor: pointer;
      margin-bottom: 10px;
    }

    .left-panel .multiplier {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 10px;
      color: #ff0000;
    }

    .balance-display {
      font-size: 14px;
      color: #ff9999;
      margin-bottom: 15px;
    }

    .game-board {
      flex-grow: 1;
      background-color: #1a1a1a;
      padding: 30px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      align-items: center;
      border: 1px solid #800000;
    }

    .game-board h2 {
      font-size: 16px;
      margin-bottom: 20px;
      color: #ff0000;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(5, 60px);
      gap: 10px;
    }

    .cell {
      width: 60px;
      height: 60px;
      border-radius: 10px;
      background-color: #800000;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      cursor: pointer;
      transition: background-color 0.2s;
      color: #ffffff;
    }

    .cell.safe {
      background-color: #ff0000;
    }

    .cell.mine {
      background-color: #1a1a1a;
      color: #ff0000;
    }

    .overlay {
      position: fixed;
      top: 30%;
      left: 50%;
      transform: translateX(-50%);
      background-color: #800000;
      color: white;
      padding: 20px 40px;
      border-radius: 12px;
      font-size: 20px;
      font-weight: bold;
      display: none;
      z-index: 9999;
    }

    .overlay .emoji {
      font-size: 26px;
      margin-right: 10px;
    }

    #bj-game {
      background: linear-gradient(to right, #1a1a1a, #2d2d2d, #800000);
      font-family: 'Segoe UI', sans-serif;
      color: white;
      text-align: center;
      padding: 30px;
      border-radius: 12px;
    }
    #bj-game h2 {
      color: #ff0000;
      font-size: 24px;
    }
    #bj-game .hand {
      margin: 20px 0;
    }
    #bj-game .card {
      display: inline-block;
      background: #ff0000;
      color: black;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 8px;
      font-weight: bold;
    }
    #bj-game button {
      padding: 12px 20px;
      font-size: 16px;
      margin: 10px;
      border: none;
      background-color: #800000;
      color: white;
      border-radius: 6px;
      cursor: pointer;
    }
    #bj-game button:hover {
      background-color: #660000;
    }
    #bj-game input {
      padding: 10px;
      font-size: 16px;
      margin: 10px;
      border: none;
      background-color: #2d2d2d;
      color: white;
      border-radius: 6px;
    }
    #bj-game #result {
      font-size: 20px;
      margin-top: 20px;
    }

    .chat-container {
      width: 100%;
      height: 100%;
      background-color: #1a1a1a;
      padding: 20px;
      border-radius: 12px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      border: 1px solid #800000;
    }
    .chat-messages {
      height: 80%;
      overflow-y: auto;
      background-color: #2d2d2d;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 15px;
    }
    .chat-messages p {
      margin: 5px 0;
      color: #ffffff;
    }
    .chat-input {
      width: 100%;
      display: flex;
      gap: 10px;
    }
    .chat-input input {
      flex-grow: 1;
      padding: 10px;
      border: none;
      border-radius: 8px;
      background-color: #2d2d2d;
      color: white;
      font-size: 14px;
    }
    .chat-input button {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      background-color: #800000;
      color: white;
      font-weight: bold;
      cursor: pointer;
    }
    .chat-input button:hover {
      background-color: #660000;
    }
  </style>
</head>
<body>
  <header>
    <div>
      <a href="#" @click.prevent="page='home'">üè† Home</a>
      <a href="#" @click.prevent="page='blackjack'">üÉè Blackjack</a>
      <a href="#" @click.prevent="page='mines'">üí£ Mines</a>
    </div>
    <a href="#" @click.prevent="logout">üö™ Logout</a>
  </header>

  <div class="container" id="app">
    <!-- Main Content (70%) -->
    <div class="main-content">
      <div class="members-panel">
        <h2>üë• Online Members</h2>
        <ul>
          <li v-for="user in onlineUsers" :key="user">{{ user }}</li>
        </ul>
      </div>
      <div class="game-content">
        <!-- Home -->
        <div v-show="page==='home'" class="text-center">
          <h2 style="font-size: 24px; color: #ff0000; margin-bottom: 15px;">Welcome, {{ username }}!</h2>
          <p style="font-size: 18px; margin-bottom: 10px;">Balance: <span id="homeBalance">{{ balance }}</span> Coins</p>
          <p style="font-size: 14px; color: #ff9999;">Choose a game above or join the chat on the right!</p>
        </div>

        <!-- Blackjack -->
        <div v-show="page==='blackjack'" id="bj-game">
          <h2>üÉè Blackjack - Hans Has Luck</h2>
          <div class="hand">
            <label style="font-size: 16px; margin-right: 10px;">Bet:</label>
            <input type="number" id="bjBet" v-model.number="bjBet" min="1">
          </div>
          <div class="hand">
            <h3>Your Hand</h3>
            <div id="player-cards"></div>
            <p id="player-total"></p>
          </div>
          <div class="hand">
            <h3>Dealer's Hand</h3>
            <div id="dealer-cards"></div>
            <p id="dealer-total"></p>
          </div>
          <div>
            <button onclick="hit()">Hit</button>
            <button onclick="stand()">Stand</button>
            <button onclick="resetGame()">New Game</button>
          </div>
          <p id="result"></p>
        </div>

        <!-- Mines -->
        <div v-show="page==='mines'" class="container">
          <div class="left-panel">
            <h2>üß™ Mines Spiel</h2>
            <label>Einsatz</label>
            <input type="number" id="betAmount" v-model.number="betAmount" value="1000">
            <label>Anzahl Minen</label>
            <select id="mineCount" v-model.number="mineCount">
              <option>1</option>
              <option>2</option>
              <option>3</option>
              <option>5</option>
              <option>10</option>
            </select>
            <div class="multiplier" id="multiplier">1.00x</div>
            <div class="balance-display">
              üí∞ Balance: <span id="minesBalance">{{ balance }}</span> Coins
            </div>
            <button onclick="startGame()">üéÆ Start Game</button>
            <button onclick="cashout()">üí∏ Auszahlen</button>
          </div>
          <div class="game-board">
            <h2>üß™ Feld ausw√§hlen</h2>
            <div class="grid" id="grid"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Chat Area (30%) -->
    <aside class="w-2/5">
      <div class="chat-container">
        <h3 style="font-size: 18px; margin-bottom: 15px; color: #ff0000;">üí¨ Chat</h3>
        <div class="chat-messages">
          <p v-for="msg in messages" :key="msg._id">
            <strong>{{ msg.username }}</strong>: {{ msg.message }}
            <span style="color: #ff9999; font-size: 12px;"> ({{ new Date(msg.timestamp).toLocaleTimeString() }})</span>
          </p>
        </div>
        <div class="chat-input">
          <input v-model="newMessage" @keyup.enter="sendMessage" placeholder="Type a message...">
          <button @click="sendMessage">Send</button>
        </div>
      </div>
    </aside>
  </div>

  <div class="overlay" id="cashoutMessage">
    <span class="emoji">üéâ</span> Ausgezahlt! +<span id="cashoutAmount"></span> Coins!
  </div>

  <!-- Blackjack Script -->
  <script>
    const playerCardsEl = document.getElementById('player-cards')
    const dealerCardsEl = document.getElementById('dealer-cards')
    const playerTotalEl = document.getElementById('player-total')
    const dealerTotalEl = document.getElementById('dealer-total')
    const resultEl = document.getElementById('result')
    const bjBetInput = document.getElementById('bjBet')

    const flipSound = new Audio('https://cdn.pixabay.com/audio/2022/03/15/audio_533c09b3e4.mp3')
    const winSound = new Audio('https://cdn.pixabay.com/audio/2021/08/04/audio_8a3c1f1e79.mp3')
    const loseSound = new Audio('https://cdn.pixabay.com/audio/2022/03/10/audio_b20b7f6e98.mp3')
    const drawSound = new Audio('https://cdn.pixabay.com/audio/2022/03/22/audio_ebedcbfdd5.mp3')

    let deck = []
    let playerHand = []
    let dealerHand = []
    let gameOver = false
    let currentBalance = 0
    let bjBet = 100

    async function fetchBalance() {
      const token = localStorage.getItem('token')
      if (!token) return 0
      const res = await fetch('/api/balance', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      const data = await res.json()
      return data.balance || 0
    }

    function createDeck() {
      const suits = ['‚ô†', '‚ô•', '‚ô£', '‚ô¶']
      const values = ['A', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'J', 'Q', 'K']
      const deck = []
      for (let suit of suits) {
        for (let value of values) {
          deck.push({ suit, value })
        }
      }
      return deck.sort(() => Math.random() - 0.5)
    }

    function getCardValue(card) {
      if (['J', 'Q', 'K'].includes(card.value)) return 10
      if (card.value === 'A') return 11
      return parseInt(card.value)
    }

    function calculateTotal(hand) {
      let total = 0
      let aces = 0
      for (let card of hand) {
        const val = getCardValue(card)
        total += val
        if (card.value === 'A') aces++
      }
      while (total > 21 && aces > 0) {
        total -= 10
        aces--
      }
      return total
    }

    function displayHand(el, hand) {
      el.innerHTML = ''
      hand.forEach(card => {
        const cardEl = document.createElement('div')
        cardEl.className = 'card'
        cardEl.textContent = `${card.value}${card.suit}`
        el.appendChild(cardEl)
      })
    }

    async function update() {
      displayHand(playerCardsEl, playerHand)
      displayHand(dealerCardsEl, dealerHand)
      playerTotalEl.textContent = 'Total: ' + calculateTotal(playerHand)
      dealerTotalEl.textContent = gameOver ? 'Total: ' + calculateTotal(dealerHand) : 'Total: ?'
      currentBalance = await fetchBalance()
      document.getElementById('homeBalance').textContent = currentBalance.toLocaleString()
      document.getElementById('minesBalance').textContent = currentBalance.toLocaleString()
      bjBet = Math.min(bjBet, currentBalance)
      bjBetInput.value = bjBet
    }

    function hit() {
      if (gameOver || bjBet > currentBalance) return alert('Insufficient balance or game over!')
      flipSound.play()
      playerHand.push(deck.pop())
      update()
      if (calculateTotal(playerHand) > 21) endGame()
    }

    function stand() {
      if (gameOver || bjBet > currentBalance) return alert('Insufficient balance or game over!')
      flipSound.play()
      while (calculateTotal(dealerHand) < 17) {
        dealerHand.push(deck.pop())
      }
      endGame()
    }

    function endGame() {
      gameOver = true
      const playerTotal = calculateTotal(playerHand)
      const dealerTotal = calculateTotal(dealerHand)

      update()

      if (playerTotal > 21) {
        resultEl.textContent = 'You Busted! üí• Dealer Wins!'
        loseSound.play()
        updateBalance(-bjBet)
      } else if (dealerTotal > 21) {
        resultEl.textContent = 'Dealer Busted! üéâ You Win!'
        winSound.play()
        updateBalance(bjBet)
      } else if (playerTotal > dealerTotal) {
        resultEl.textContent = 'You Win! üéâ'
        winSound.play()
        updateBalance(bjBet)
      } else if (playerTotal < dealerTotal) {
        resultEl.textContent = 'Dealer Wins! üò¢'
        loseSound.play()
        updateBalance(-bjBet)
      } else {
        resultEl.textContent = 'Push (Tie)! ü§ù'
        drawSound.play()
      }
    }

    function resetGame() {
      if (bjBet > currentBalance) return alert('Insufficient balance!')
      deck = createDeck()
      playerHand = [deck.pop(), deck.pop()]
      dealerHand = [deck.pop()]
      gameOver = false
      resultEl.textContent = ''
      update()
    }

    async function updateBalance(change) {
      const token = localStorage.getItem('token')
      const res = await fetch('/api/balance', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      const data = await res.json()
      currentBalance = data.balance
      const newBalance = currentBalance + change
      const updateRes = await fetch('/api/balance', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ balance: newBalance })
      })
      if (!updateRes.ok) {
        alert('Error updating balance. Data may have been modified.')
        await fetchBalance()
      }
      await update()
    }

    resetGame()
  </script>

  <!-- Mines Script -->
  <script>
    let isGameActive = false
    let safeTiles = []
    let clickedTiles = new Set()
    let bet = 0
    let mines = 3
    let multiplier = 1
    let currentBalance = 0

    async function fetchBalance() {
      const token = localStorage.getItem('token')
      if (!token) return 0
      const res = await fetch('/api/balance', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      const data = await res.json()
      return data.balance || 0
    }

    async function updateBalance(change) {
      const token = localStorage.getItem('token')
      const res = await fetch('/api/balance', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      const data = await res.json()
      currentBalance = data.balance
      const newBalance = currentBalance + change
      const updateRes = await fetch('/api/balance', {
        method: 'POST',
        headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
        body: JSON.stringify({ balance: newBalance })
      })
      if (!updateRes.ok) {
        alert('Error updating balance. Data may have been modified.')
        return await fetchBalance()
      }
      return await fetchBalance()
    }

    function startGame() {
      fetchBalance().then(async (balance) => {
        bet = parseInt(document.getElementById('betAmount').value)
        mines = parseInt(document.getElementById('mineCount').value)
        if (bet <= 0 || bet > balance) return alert('Invalid bet.')
        const newBalance = await updateBalance(-bet)
        document.getElementById('minesBalance').textContent = newBalance.toLocaleString()
        document.getElementById('multiplier').textContent = '1.00x'
        multiplier = 1
        clickedTiles = new Set()
        isGameActive = true
        generateGrid()
      })
    }

    function generateGrid() {
      const grid = document.getElementById('grid')
      grid.innerHTML = ''
      safeTiles = Array(25).fill('safe')
      for (let i = 0; i < mines; i++) {
        let idx
        do {
          idx = Math.floor(Math.random() * 25)
        } while (safeTiles[idx] === 'mine')
        safeTiles[idx] = 'mine'
      }

      for (let i = 0; i < 25; i++) {
        const cell = document.createElement('div')
        cell.className = 'cell'
        cell.onclick = () => handleClick(i, cell)
        grid.appendChild(cell)
      }
    }

    function handleClick(index, cell) {
      if (!isGameActive || clickedTiles.has(index)) return
      clickedTiles.add(index)
      if (safeTiles[index] === 'mine') {
        cell.classList.add('mine')
        cell.innerHTML = 'üí£'
        isGameActive = false
        alert('üí• You hit a mine! Game over.')
      } else {
        cell.classList.add('safe')
        cell.innerHTML = 'üíé'
        multiplier = (multiplier * 1.15).toFixed(2)
        document.getElementById('multiplier').textContent = `${multiplier}x`
      }
    }

    function cashout() {
      if (!isGameActive || clickedTiles.size === 0) return
      const payout = Math.floor(bet * multiplier)
      updateBalance(payout).then(() => {
        showCashout(payout)
        isGameActive = false
      })
    }

    function showCashout(amount) {
      const overlay = document.getElementById('cashoutMessage')
      document.getElementById('cashoutAmount').textContent = amount.toLocaleString()
      overlay.style.display = 'block'
      setTimeout(() => {
        overlay.style.display = 'none'
      }, 3000)
    }
  </script>

  <!-- Chat + Tabs Script -->
  <script type="module">
    import { createApp } from 'https://cdn.jsdelivr.net/npm/vue@3.4.38/dist/vue.esm-browser.js'
    const socket = io()

    async function fetchBalance() {
      const token = localStorage.getItem('token')
      if (!token) return 0
      const res = await fetch('/api/balance', {
        headers: { 'Authorization': `Bearer ${token}` }
      })
      const data = await res.json()
      return data.balance || 0
    }

    function logout() {
      localStorage.removeItem('token')
      window.location.href = '/login'
    }

    createApp({
      data() { return {
        page: 'home',
        username: localStorage.getItem('username') || 'Guest',
        balance: 0,
        messages: [],
        newMessage: '',
        bjBet: 100,
        betAmount: 1000,
        mineCount: 3,
        onlineUsers: []
      }},
      computed: {
        tabClass() {
          return (tab) => this.page === tab ? 'text-ff0000 font-bold' : 'hover:text-ff9999'
        }
      },
      methods: {
        async sendMessage() {
          if (this.newMessage.trim()) {
            socket.emit('message', this.newMessage)
            this.newMessage = ''
          }
        },
        async updateBalanceDisplay() {
          this.balance = await fetchBalance()
          document.getElementById('homeBalance').textContent = this.balance.toLocaleString()
          document.getElementById('minesBalance').textContent = this.balance.toLocaleString()
        }
      },
      async mounted() {
        await this.updateBalanceDisplay()
        socket.emit('join', { username: this.username, token: localStorage.getItem('token') })
        socket.on('messages', m => this.messages = m)
        socket.on('message', m => this.messages.push(m))
        socket.on('users', users => this.onlineUsers = users)
        setInterval(this.updateBalanceDisplay, 5000)
      }
    }).mount('#app')
  </script>
</body>
</html>